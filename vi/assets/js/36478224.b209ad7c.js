"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1114],{90346:(e,t,a)=>{a.d(t,{Ey:()=>p,O2:()=>c,SQ:()=>d});var n=a(67294),r=a(74866),o=a(85162),l=a(1841),i=a.n(l),s=a(95665),u=a.n(s);function c(e){var t=e.children;return Array.isArray(t)||(t=[t]),n.createElement(r.Z,{className:"language-tabs",groupId:"code-tabs"},t.map((function(e,t){return n.createElement(o.Z,{value:e.props.value,label:e.props.value},e)})))}function d(e){var t=e.children,a=e.language;return Array.isArray(t)||(t=[t]),t=t.map((function(e){return function(e,t){var a=e.props,r=a.children,o=a.url,l=a.start,s=a.end,u=a.fname;if("Github"==e.props.mdxType)return p({url:o,start:l,end:s,language:t,fname:u});if("CodeBlock"==e.props.mdxType)return n.createElement(i(),{fname:u,language:t},r);return e}(e,a)})),1==t.length?n.createElement(o.Z,{value:0,label:t[0].props.fname},t[0]):n.createElement(r.Z,{className:"file-tabs"},t.map((function(e,t){return n.createElement(o.Z,{value:t,label:e.props.fname},e)})))}function p(e){var t=e.url,a=e.start,r=e.end,o=e.language,l=e.fname,i=t+"#";return a&&r&&(i+="L"+a+"-L"+r+"#"),n.createElement(u(),{language:o,fname:l},i)}},85162:(e,t,a)=>{a.d(t,{Z:()=>l});var n=a(67294),r=a(86010);const o="tabItem_Ymn6";function l(e){var t=e.children,a=e.hidden,l=e.className;return n.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,l),hidden:a},t)}},74866:(e,t,a)=>{a.d(t,{Z:()=>N});var n=a(87462),r=a(67294),o=a(86010),l=a(12466),i=a(76775),s=a(91980),u=a(67392),c=a(50012);function d(e){return function(e){return r.Children.map(e,(function(e){if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')}))}(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}function p(e){var t=e.values,a=e.children;return(0,r.useMemo)((function(){var e=null!=t?t:d(a);return function(e){var t=(0,u.l)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,a])}function h(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function m(e){var t=e.queryString,a=void 0!==t&&t,n=e.groupId,o=(0,i.k6)(),l=function(e){var t=e.queryString,a=void 0!==t&&t,n=e.groupId;if("string"==typeof a)return a;if(!1===a)return null;if(!0===a&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=n?n:null}({queryString:a,groupId:n});return[(0,s._X)(l),(0,r.useCallback)((function(e){if(l){var t=new URLSearchParams(o.location.search);t.set(l,e),o.replace(Object.assign({},o.location,{search:t.toString()}))}}),[l,o])]}function g(e){var t,a,n,o,l=e.defaultValue,i=e.queryString,s=void 0!==i&&i,u=e.groupId,d=p(e),g=(0,r.useState)((function(){return function(e){var t,a=e.defaultValue,n=e.tabValues;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(a){if(!h({value:a,tabValues:n}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+a+'" but none of its children has the corresponding value. Available values are: '+n.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return a}var r=null!=(t=n.find((function(e){return e.default})))?t:n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:l,tabValues:d})})),f=g[0],y=g[1],k=m({queryString:s,groupId:u}),b=k[0],v=k[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:u}.groupId),a=(0,c.Nk)(t),n=a[0],o=a[1],[n,(0,r.useCallback)((function(e){t&&o.set(e)}),[t,o])]),N=w[0],C=w[1],T=function(){var e=null!=b?b:N;return h({value:e,tabValues:d})?e:null}();return(0,r.useLayoutEffect)((function(){T&&y(T)}),[T]),{selectedValue:f,selectValue:(0,r.useCallback)((function(e){if(!h({value:e,tabValues:d}))throw new Error("Can't select invalid tab value="+e);y(e),v(e),C(e)}),[v,C,d]),tabValues:d}}var f=a(72389);const y="tabList__CuJ",k="tabItem_LNqP";function b(e){var t=e.className,a=e.block,i=e.selectedValue,s=e.selectValue,u=e.tabValues,c=[],d=(0,l.o5)().blockElementScrollPositionUntilNextRender,p=function(e){var t=e.currentTarget,a=c.indexOf(t),n=u[a].value;n!==i&&(d(t),s(n))},h=function(e){var t,a=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":var n,r=c.indexOf(e.currentTarget)+1;a=null!=(n=c[r])?n:c[0];break;case"ArrowLeft":var o,l=c.indexOf(e.currentTarget)-1;a=null!=(o=c[l])?o:c[c.length-1]}null==(t=a)||t.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":a},t)},u.map((function(e){var t=e.value,a=e.label,l=e.attributes;return r.createElement("li",(0,n.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:function(e){return c.push(e)},onKeyDown:h,onClick:p},l,{className:(0,o.Z)("tabs__item",k,null==l?void 0:l.className,{"tabs__item--active":i===t})}),null!=a?a:t)})))}function v(e){var t=e.lazy,a=e.children,n=e.selectedValue;if(a=Array.isArray(a)?a:[a],t){var o=a.find((function(e){return e.props.value===n}));return o?(0,r.cloneElement)(o,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},a.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n})})))}function w(e){var t=g(e);return r.createElement("div",{className:(0,o.Z)("tabs-container",y)},r.createElement(b,(0,n.Z)({},e,t)),r.createElement(v,(0,n.Z)({},e,t)))}function N(e){var t=(0,f.Z)();return r.createElement(w,(0,n.Z)({key:String(t)},e))}},37840:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>u,default:()=>m,frontMatter:()=>s,metadata:()=>c,toc:()=>p});var n=a(87462),r=a(63366),o=(a(67294),a(3905)),l=a(90346),i=["components"],s={id:"prototyping",sidebar_label:"Rapid Prototyping",title:"Upgrading Contracts: Rapid Prototyping"},u="Rapid Prototyping",c={unversionedId:"sdk/rust/building/prototyping",id:"sdk/rust/building/prototyping",title:"Upgrading Contracts: Rapid Prototyping",description:"When you change the interface of a contract and re-deploy it, you may see this error:",source:"@site/../docs/sdk/rust/building/prototyping.md",sourceDirName:"sdk/rust/building",slug:"/sdk/rust/building/prototyping",permalink:"/near-docs-kor/vi/sdk/rust/building/prototyping",draft:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/sdk/rust/building/prototyping.md",tags:[],version:"current",lastUpdatedBy:"[sm-stack]",lastUpdatedAt:1675844989,formattedLastUpdatedAt:"8 thg 2, 2023",frontMatter:{id:"prototyping",sidebar_label:"Rapid Prototyping",title:"Upgrading Contracts: Rapid Prototyping"},sidebar:"sdk",previous:{title:"Basic Instructions",permalink:"/near-docs-kor/vi/sdk/rust/building/basics"},next:{title:"Post Processing Tools",permalink:"/near-docs-kor/vi/sdk/rust/building/post-processing"}},d={},p=[{value:"Why does this happen?",id:"why-does-this-happen",level:3},{value:"How can you avoid such errors?",id:"how-can-you-avoid-such-errors",level:3},{value:"Rapid Prototyping: Delete Everything All The Time",id:"rapid-prototyping-delete-everything-all-the-time",level:2},{value:"1. <code>rm -rf neardev &amp;&amp; near dev-deploy</code>",id:"1-rm--rf-neardev--near-dev-deploy",level:3},{value:"2. Deleting &amp; recreating contract account",id:"2-deleting--recreating-contract-account",level:3}],h={toc:p};function m(e){var t=e.components,a=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"rapid-prototyping"},"Rapid Prototyping"),(0,o.kt)("p",null,"When you change the interface of a contract and re-deploy it, you may see this error:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Cannot deserialize the contract state.\n")),(0,o.kt)("h3",{id:"why-does-this-happen"},"Why does this happen?"),(0,o.kt)("p",null,"When your contract is executed, the NEAR Runtime reads the serialized state from disk and attempts to load it using current contract code. When your code changes but the serialized state stays the same, it can't figure out how to do this."),(0,o.kt)("h3",{id:"how-can-you-avoid-such-errors"},"How can you avoid such errors?"),(0,o.kt)("p",null,"When you're still in the Research & Development phase, building a prototype and deploying it locally or on ",(0,o.kt)("a",{parentName:"p",href:"/concepts/basics/networks"},"testnet"),", you can just delete all previous contract state when you make a breaking change. See below for a couple ways to do this."),(0,o.kt)("p",null,"When you're ready to deploy a more stable contract, there are a couple of ",(0,o.kt)("a",{parentName:"p",href:"/near-docs-kor/vi/develop/upgrade#migrating-the-state"},"production strategies"),' that will help you update the contract state without deleting it all. And once your contract graduates from "trusted mode" (when maintainers control a ',(0,o.kt)("a",{parentName:"p",href:"/concepts/basics/accounts/access-keys"},"Full Access key"),") to community-governed mode (no more Full Access keys), you can set up your contract to ",(0,o.kt)("a",{parentName:"p",href:"/near-docs-kor/vi/develop/upgrade#programmatic-update"},"upgrade itself"),"."),(0,o.kt)("h2",{id:"rapid-prototyping-delete-everything-all-the-time"},"Rapid Prototyping: Delete Everything All The Time"),(0,o.kt)("p",null,"There are two ways to delete all account state:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"rm -rf neardev && near dev-deploy")),(0,o.kt)("li",{parentName:"ol"},"Deleting & recreating contract account")),(0,o.kt)("p",null,"For both cases, let's consider the following example."),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/near-examples/rust-status-message"},"rust-status-message")," example contract has the following structure:"),(0,o.kt)(l.O2,{mdxType:"CodeTabs"},(0,o.kt)(l.SQ,{value:"\ud83e\udd80 Rust",language:"rust",mdxType:"Language"},(0,o.kt)(l.Ey,{fname:"lib.rs",url:"https://github.com/near-examples/rust-status-message/blob/b5fa6f2a30559d56a3a3ea52da8c26c5d3907606/src/lib.rs",start:"5",end:"29",mdxType:"Github"}))),(0,o.kt)("p",null,"Let's say you deploy this contract to testnet, then call it with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'near call [contract] set_status \'{"message": "lol"}\' --accountId you.testnet\nnear view [contract] get_status \'{"account_id": "you.testnet"}\'\n')),(0,o.kt)("p",null,"This will return the message that you set with the call to ",(0,o.kt)("inlineCode",{parentName:"p"},"set_status"),", in this case ",(0,o.kt)("inlineCode",{parentName:"p"},'"lol"'),"."),(0,o.kt)("p",null,"At this point the contract is deployed and has some state. "),(0,o.kt)("p",null,"Now let's say you change the contract to store two kinds of data for each account:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},'#[near_bindgen]\n#[derive(BorshDeserialize, BorshSerialize)]\npub struct StatusMessage {\n    taglines: LookupMap<AccountId, String>,\n    bios: LookupMap<AccountId, String>,\n}\n\nimpl Default for StatusMessage {\n    fn default() -> Self {\n        Self {\n            taglines: LookupMap::new(b"r"),\n            bios: LookupMap::new(b"b"),\n        }\n    }\n}\n\n#[near_bindgen]\nimpl StatusMessage {\n    pub fn set_tagline(&mut self, message: String) {\n        let account_id = env::signer_account_id();\n        self.taglines.insert(&account_id, &message);\n    }\n\n    pub fn get_tagline(&self, account_id: AccountId) -> Option<String> {\n        return self.taglines.get(&account_id);\n    }\n\n    pub fn set_bio(&mut self, message: String) {\n        let account_id = env::signer_account_id();\n        self.bios.insert(&account_id, &message);\n    }\n\n    pub fn get_bio(&self, account_id: AccountId) -> Option<String> {\n        return self.bios.get(&account_id);\n    }\n}\n')),(0,o.kt)("p",null,"You build & deploy the contract again, thinking that maybe because the new ",(0,o.kt)("inlineCode",{parentName:"p"},"taglines")," LookupMap has the same prefix as the old ",(0,o.kt)("inlineCode",{parentName:"p"},"records")," LookupMap (the prefix is ",(0,o.kt)("inlineCode",{parentName:"p"},"r"),", set by ",(0,o.kt)("inlineCode",{parentName:"p"},'LookupMap::new(b"r".to_vec())'),"), the tagline for ",(0,o.kt)("inlineCode",{parentName:"p"},"you.testnet")," should be ",(0,o.kt)("inlineCode",{parentName:"p"},'"lol"'),". But when you ",(0,o.kt)("inlineCode",{parentName:"p"},"near view"),' the contract, you get the "Cannot deserialize" message. What to do?'),(0,o.kt)("h3",{id:"1-rm--rf-neardev--near-dev-deploy"},"1. ",(0,o.kt)("inlineCode",{parentName:"h3"},"rm -rf neardev && near dev-deploy")),(0,o.kt)("p",null,"When first getting started with a new project, the fastest way to deploy a contract is ",(0,o.kt)("a",{parentName:"p",href:"/concepts/basics/accounts/creating-accounts"},(0,o.kt)("inlineCode",{parentName:"a"},"dev-deploy")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"near dev-deploy [--wasmFile ./path/to/compiled.wasm]\n")),(0,o.kt)("p",null,"This does a few things:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Creates a new testnet account with a name like ",(0,o.kt)("inlineCode",{parentName:"li"},"dev-1626793583587-89195915741581")),(0,o.kt)("li",{parentName:"ol"},"Stores this account name in a ",(0,o.kt)("inlineCode",{parentName:"li"},"neardev")," folder within the project"),(0,o.kt)("li",{parentName:"ol"},"Stores the private key for this account in the ",(0,o.kt)("inlineCode",{parentName:"li"},"~/.near-credentials")," folder"),(0,o.kt)("li",{parentName:"ol"},"Deploys your contract code to this account")),(0,o.kt)("p",null,"The next time you run ",(0,o.kt)("inlineCode",{parentName:"p"},"dev-deploy"),", it checks the ",(0,o.kt)("inlineCode",{parentName:"p"},"neardev")," folder and re-deploys to the same account rather than making a new one."),(0,o.kt)("p",null,"But in the example above, we want to delete the account state. How do we do that?"),(0,o.kt)("p",null,"The easiest way is just to delete the ",(0,o.kt)("inlineCode",{parentName:"p"},"neardev")," folder, then run ",(0,o.kt)("inlineCode",{parentName:"p"},"near dev-deploy")," again. This will create a brand new testnet account, with its own (empty) state, and deploy the updated contract to it."),(0,o.kt)("h3",{id:"2-deleting--recreating-contract-account"},"2. Deleting & recreating contract account"),(0,o.kt)("p",null,"If you want to have a predictable account name rather than an ever-changing ",(0,o.kt)("inlineCode",{parentName:"p"},"dev-*")," account, the best way is probably to create a sub-account:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Create sub-account"',title:'"Create','sub-account"':!0},"near create-account app-name.you.testnet --masterAccount you.testnet\n")),(0,o.kt)("p",null,"Then deploy your contract to it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Deploy to sub-account"',title:'"Deploy',to:!0,'sub-account"':!0},"near deploy --accountId app-name.you.testnet [--wasmFile ./path/to/compiled.wasm]\n")),(0,o.kt)("p",null,"In this case, how do you delete all contract state and start again? Delete the sub-account and recreate it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Delete sub-account"',title:'"Delete','sub-account"':!0},"near delete app-name.you.testnet you.testnet\n")),(0,o.kt)("p",null,"This sends all funds still on the ",(0,o.kt)("inlineCode",{parentName:"p"},"app-name.you.testnet")," account to ",(0,o.kt)("inlineCode",{parentName:"p"},"you.testnet")," and deletes the contract that had been deployed to it, including all contract state."),(0,o.kt)("p",null,"Now you create the sub-account and deploy to it again using the commands above, and it will have empty state like it did the first time you deployed it."))}m.isMDXComponent=!0}}]);