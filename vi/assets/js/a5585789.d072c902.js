"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[160],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=p(n),u=r,h=m["".concat(l,".").concat(u)]||m[u]||d[u]||o;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},21191:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>p,toc:()=>d});var a=n(87462),r=n(63366),o=(n(67294),n(3905)),i=["components"],s={id:"realtime",title:"Track Real Time Events"},l=void 0,p={unversionedId:"tools/realtime",id:"tools/realtime",title:"Track Real Time Events",description:"While developing a decentralized app you might want track specific events in real time. For example, you could want",source:"@site/../docs/4.tools/events.md",sourceDirName:"4.tools",slug:"/tools/realtime",permalink:"/near-docs-kor/vi/tools/realtime",draft:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/4.tools/events.md",tags:[],version:"current",lastUpdatedBy:"[sm-stack]",lastUpdatedAt:1675844989,formattedLastUpdatedAt:"8 thg 2, 2023",frontMatter:{id:"realtime",title:"Track Real Time Events"},sidebar:"develop",previous:{title:"Build the Web Frontend",permalink:"/near-docs-kor/vi/develop/integrate/frontend"},next:{title:"Query the Blockchain History",permalink:"/near-docs-kor/vi/tools/indexer-for-explorer"}},c={},d=[{value:"NEP-297 - Events",id:"nep-297---events",level:2},{value:"Listening to Events (Mainnet)",id:"listening-to-events-mainnet",level:2},{value:"NEAR Lake Indexer",id:"near-lake-indexer",level:2},{value:"How it works",id:"how-it-works",level:3},{value:"Data structure",id:"data-structure",level:3},{value:"How to use it",id:"how-to-use-it",level:3}],m={toc:d};function u(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"While developing a decentralized app you might want track specific events in real time. For example, you could want\nto be informed each time a specific NFT marketplace makes a sell. For this to be possible you need:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"A way for the contract to inform that an event took place."),(0,o.kt)("li",{parentName:"ol"},"A way to track such events in real time.")),(0,o.kt)("p",null,"To tackle these challenges is that the ",(0,o.kt)("a",{parentName:"p",href:"https://nomicon.io/Standards/EventsFormat"},"standard events format (NEP-297)")," was created.\n",(0,o.kt)("a",{parentName:"p",href:"https://nomicon.io/Standards/EventsFormat"},"NEP-297")," defines a standard way for contracts to inform about an event. Since these\nevents are public, a service can then be built to track them in real time through the use of websocket."),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"nep-297---events"},"NEP-297 - Events"),(0,o.kt)("p",null,"In NEAR, ",(0,o.kt)("inlineCode",{parentName:"p"},"Events")," use the standard logs capability of contracts, since every log is forever stored in the blockchain. In this way,\nEvents are normal log entries that start with the ",(0,o.kt)("inlineCode",{parentName:"p"},"EVENT_JSON:")," prefix, followed by a single valid JSON string. The JSON string\nmust codify an object with the following interface:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"interface EventLogData {\n    standard: string, // name of standard, e.g. nep171\n    version: string, // e.g. 1.0.0\n    event: string, // type of the event, e.g. nft_mint\n    data?: unknown, // event data defined in the nep171\n}\n")),(0,o.kt)("p",null,"See the ",(0,o.kt)("a",{parentName:"p",href:"https://nomicon.io/Standards/EventsFormat"},"NEP-297 page")," for examples."),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"There is a known limitation of 16kb strings when capturing logs")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"listening-to-events-mainnet"},"Listening to Events (Mainnet)"),(0,o.kt)("p",null,"To listen to events in the ",(0,o.kt)("inlineCode",{parentName:"p"},"mainnet")," simply connect to the secure websocket ",(0,o.kt)("inlineCode",{parentName:"p"},"wss://events.near.stream/ws"),". There is no websocket ",(0,o.kt)("strong",{parentName:"p"},"for ",(0,o.kt)("inlineCode",{parentName:"strong"},"testnet")),"."),(0,o.kt)("p",null,"As first message you will need to pass an object stating the type of events you want to filter for, and a limit if necessary. For example, here we filter for the ",(0,o.kt)("inlineCode",{parentName:"p"},"nft_mint")," event in the ",(0,o.kt)("inlineCode",{parentName:"p"},"nft.nearapps.near")," account."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  secret: "ohyeahnftsss",\n  filter: [{\n    "account_id": "nft.nearapps.near",\n    "status": "SUCCESS",\n    "event": {\n      "standard": "nep171",\n      "event": "nft_mint",\n    }\n  }],\n  fetch_past_events: 20,\n}\n')),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"There is no websocket implemented for ",(0,o.kt)("inlineCode",{parentName:"p"},"testnet"),", but you can run your own using this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/evgenykuzyakov/indexer-tutorials/tree/master/example-indexer"},"modified indexer")," to\npopulate a database with events, and then serve them using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/evgenykuzyakov/event-api"},"event-api project"),". ")),(0,o.kt)("admonition",{title:"Reference implementation",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If you need a reference implementation, ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/evgenykuzyakov/nft-mints"},"here is a project from Evgeny Kuzyakov"),"\nthat listens for ",(0,o.kt)("strong",{parentName:"p"},"all")," ",(0,o.kt)("inlineCode",{parentName:"p"},"nft_mint")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"nft_transfer")," events in the NEAR network.")),(0,o.kt)("hr",null),(0,o.kt)("h2",{id:"near-lake-indexer"},"NEAR Lake Indexer"),(0,o.kt)("p",null,"NEAR Lake is an indexer built on top of ",(0,o.kt)("a",{parentName:"p",href:"https://near-indexers.io/docs/projects/near-indexer-framework"},"NEAR Indexer Framework")," to watch the network and store all the events as JSON files on AWS S3."),(0,o.kt)("admonition",{title:"GitHub repo",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can find the Lake Indexer source code in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/near/near-lake-indexer/"},"this GitHub repository"),".")),(0,o.kt)("h3",{id:"how-it-works"},"How it works"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"https://pagoda.co"},"Pagoda Inc.")," runs NEAR Lake nodes to store the data in JSON format on AWS S3.\nThere is no need to run your own NEAR Lake unless you have specific reasons to do that.")),(0,o.kt)("p",null,"There are AWS S3 buckets created:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"near-lake-data-testnet")," (",(0,o.kt)("inlineCode",{parentName:"li"},"eu-central-1")," region)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"near-lake-data-mainnet")," (",(0,o.kt)("inlineCode",{parentName:"li"},"eu-central-1")," region)")),(0,o.kt)("p",null,"All the buckets are set up the way the requester pays for the access. Anyone can read from these buckets by connecting to them with their own AWS credentials to be charged by Amazon."),(0,o.kt)("h3",{id:"data-structure"},"Data structure"),(0,o.kt)("p",null,"The data structure used by Lake Indexer is the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"    <block_height>/\n      block.json\n      shard_0.json\n      shard_1.json\n      ...\n      shard_N.json\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"<block_height>")," is a 12-character-long ",(0,o.kt)("a",{parentName:"p",href:"https://doc.rust-lang.org/std/primitive.u64.html"},(0,o.kt)("inlineCode",{parentName:"a"},"u64")),' string with leading zeros (e.g "000042839521"). See ',(0,o.kt)("a",{parentName:"p",href:"https://github.com/near/near-lake/issues/23"},"this issue for reasoning"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"block_json")," contains JSON-serialized ",(0,o.kt)("inlineCode",{parentName:"p"},"BlockView")," struct. ",(0,o.kt)("strong",{parentName:"p"},"NB!")," this struct might change in the future, we will announce it"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"shard_N.json")," where N is ",(0,o.kt)("a",{parentName:"p",href:"https://doc.rust-lang.org/std/primitive.u64.html"},(0,o.kt)("inlineCode",{parentName:"a"},"u64"))," starting from ",(0,o.kt)("inlineCode",{parentName:"p"},"0"),". Represents the index number of the shard. In order to find out the expected number of shards in the block you can look in ",(0,o.kt)("inlineCode",{parentName:"p"},"block.json")," at ",(0,o.kt)("inlineCode",{parentName:"p"},".header.chunks_included")),(0,o.kt)("h3",{id:"how-to-use-it"},"How to use it"),(0,o.kt)("p",null,"We have created the ",(0,o.kt)("a",{parentName:"p",href:"https://near-indexers.io/docs/projects/near-lake-framework"},"NEAR Lake Framework")," to have a simple straightforward way to create an indexer on top of the data stored by NEAR Lake itself."),(0,o.kt)("admonition",{title:"NEAR Lake Framework",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can check the NEAR Lake Framework release announcement on the ",(0,o.kt)("a",{parentName:"p",href:"https://gov.near.org/t/announcement-near-lake-framework-brand-new-word-in-indexer-building-approach/17668"},"NEAR Governance Forum"),".")),(0,o.kt)("p",null,"We have prepared this video tutorial with a simple example to give you an overview and some practical ideas."),(0,o.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/GsF7I93K-EQ",title:"NEAR Lake Indexer",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}))}u.isMDXComponent=!0}}]);